<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>JWT Auth Tester</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; padding: 24px; background:#f7f7f8;}
    h1 { margin: 0 0 12px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size: 12px; color:#374151; display:block; margin-bottom:6px; }
    input, select { padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; min-width:200px; }
    button { padding:10px 14px; border:1px solid #111827; background:#111827; color:#fff; border-radius:8px; cursor:pointer; }
    button.secondary { background:#fff; color:#111827; }
    #tokenView { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#111827; color:#e5e7eb; padding:8px 10px; border-radius:6px; display:inline-block; max-width:100%; overflow-wrap:anywhere; }
    #logs { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1020; color:#d1e7ff; padding:12px; border-radius:10px; min-height:200px; border:1px solid #0f172a; }
    .muted { color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
<h1>JWT Auth Tester</h1>

<div class="card">
  <div class="row" style="gap:20px;">
    <div>
      <label>BASE_URL</label>
      <input id="baseUrl" value="http://localhost:8080" />
    </div>
    <div>
      <label>현재 accessToken</label>
      <div id="tokenView">없음</div>
    </div>
    <div class="row">
      <button class="secondary" onclick="clearToken()">accessToken 초기화</button>
    </div>
  </div>
</div>

<div class="card">
  <h3>회원가입 / 로그인</h3>
  <div class="row">
    <div>
      <label>username</label>
      <input id="username" placeholder="user01" />
    </div>
    <div>
      <label>password</label>
      <input id="password" placeholder="pass1234" type="password" />
    </div>
    <div>
      <label>role (login엔 필요 없는 값)</label>
      <select id="role">
        <option value="USER">USER</option>
        <option value="ADMIN">ADMIN</option>
      </select>
    </div>
  </div>
  <div class="row" style="margin-top:12px;">
    <button onclick="signUp()">/auth/sign-up</button>
    <button onclick="login()">/auth/login</button>
    <button class="secondary" onclick="refresh()">/auth/refresh (쿠키 필요)</button>
  </div>
  <div class="muted" style="margin-top:8px;">
    access는 15초, refresh는 1분.
  </div>
</div>

<div class="card">
  <h3>권한 테스트</h3>
  <div class="row">
    <button onclick="callUser()">/role/user (USER 필요)</button>
    <button onclick="callAdmin()">/role/admin (ADMIN 필요)</button>
  </div>
</div>

<div class="card">
  <div class="row">
    <button class="secondary" onclick="clearLogs()">로그 지우기</button>
  </div>
  <h3>Logs</h3>
  <div id="logs"></div>
</div>

<script>
  let accessToken = null;

  function setToken(token) {
    accessToken = token || null;
    const v = document.getElementById('tokenView');
    if (!accessToken) { v.textContent = '없음'; return; }
    const short = accessToken.length > 30 ? accessToken.slice(0, 20) + ' ... ' + accessToken.slice(-10) : accessToken;
    v.textContent = short;
  }
  function clearToken() { setToken(null); log('accessToken cleared'); }

  function log(...args) {
    const el = document.getElementById('logs');
    const ts = new Date().toISOString();
    el.textContent += `[${ts}] ${args.map(a => (typeof a === 'string' ? a : JSON.stringify(a, null, 2))).join(' ')}\n`;
    el.scrollTop = el.scrollHeight;
  }
  function clearLogs() { document.getElementById('logs').textContent = ''; }

  function base() { return document.getElementById('baseUrl').value.replace(/\/+$/,''); }

  async function req(path, { method='GET', body=null, withAuth=false, withJson=true } = {}) {
    const headers = {};
    if (withJson) headers['Content-Type'] = 'application/json';
    if (withAuth && accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
    const res = await fetch(base() + path, {
      method,
      headers,
      body: body && withJson ? JSON.stringify(body) : body,
      credentials: 'include', // 쿠키 전송/수신 (refresh에 필요)
    });
    const ct = res.headers.get('content-type') || '';
    let data = null;
    if (ct.includes('application/json')) {
      try { data = await res.json(); } catch { data = await res.text(); }
    } else {
      data = await res.text();
    }
    log(`${method} ${path} → ${res.status}`, data);
    return { res, data };
  }

  async function signUp() {
    const username = document.getElementById('username').value?.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    if (!username || !password) return log('username/password 입력');

    await req('/auth/sign-up', {
      method: 'POST',
      body: { userName: username, password, role } // SignupRequest와 키 맞추세요
    });
  }

  async function login() {
    const username = document.getElementById('username').value?.trim();
    const password = document.getElementById('password').value;
    if (!username || !password) return log('username/password 입력');

    const { res, data } = await req('/auth/login', {
      method: 'POST',
      body: { userName: username, password }
    });

    if (res.ok && data && data.accessToken) {
      setToken(data.accessToken);
      log('accessToken 저장 완료');
    } else {
      log('accessToken을 응답에서 찾지 못했습니다. LoginResponse 형식을 확인하세요.');
    }
  }

  async function refresh() {
    // refreshToken은 HttpOnly 쿠키로 전송됨. JS로 읽을 수 없음이 정상.
    const { res, data } = await req('/auth/refresh', { method:'POST' });
    if (res.ok && data && data.accessToken) {
      setToken(data.accessToken);
      log('새 accessToken 저장 완료 (refresh)');
    } else {
      log('refresh 응답에 accessToken이 없습니다. 서버 응답 형식 확인.');
    }
  }

  async function callUser() {
    await req('/role/user', { method:'POST', withAuth:true });
  }

  async function callAdmin() {
    await req('/role/admin', { method:'POST', withAuth:true });
  }

  // 초기 표시
  setToken(null);
  log('페이지 로드 완료. BASE_URL을 확인하고 테스트하세요.');
</script>
</body>
</html>
